---
title: "Graphs for Report"
author: "Elena Shaw"
date: "27/06/2020"
output: pdf_document
---

```{r include=FALSE}
library(dplyr)
library(tidyr)
library(purrr)
library(ggplot2)
library(pwr)

setwd('/Users/elenashaw/Documents/UoE/Dissertation/CancerGenom/code/myCode/')
data = read.csv('data/2_model_ready_data.csv')
data_pvals = read.csv('data/2_binom_test_data.csv')
val_data = read.csv('data/2_validation_ready_data.csv')
htest_results = read.csv('data/2_qval_CI_test_results.csv')
val_htest = read.csv('data/2_qval_validation_results.csv')
# all_qvals = read.csv('data/2_adjusted_qval_comparison.csv')
bayes_bin_results = read.csv('data/2_Bayesian_mcmc_scores.csv')

total_patients = 59815

# val_htest %>% filter(BF_q_reject==T) %>% nrow()
# val_htest %>% filter(BY_q_reject==T) %>% nrow()
```

# Refs
```{r}
all_TPs = read.csv('data/2_all_TPs.csv')

our_cBios = all_TPs %>% filter(comparison=='cBio_TP') %>% select(Codon_Id,comparison) %>% unique()
our_changs = all_TPs %>% filter(comparison=='Chang_TP') %>% select(Codon_Id,comparison) %>% unique()
our_browns = all_TPs %>% filter(comparison=='Brown_TP') %>% select(Codon_Id,comparison) %>% unique()
our_mutagenes_TP = all_TPs %>% filter(comparison=='Mutagene_TP') %>% select(Codon_Id,comparison) %>% unique()
consensus_TPs = inner_join(
                  inner_join(
                    inner_join(our_cBios,our_changs, by='Codon_Id'),
                    our_browns, by='Codon_Id'),
                  our_mutagenes_TP, by='Codon_Id') %>% mutate(comparison='consensus')

# 55,203 TPs
combined_TPs = all_TPs %>% select(Codon_Id,comparison) %>% unique()


all_FPs = read.csv('data/2_potential_FP.csv')
our_mutagenes_FP = all_FPs %>% filter(comparison=='Mutagene_FP') %>% select(Codon_Id,comparison) %>% unique()
our_brown_FP = all_FPs %>% filter(comparison=='Brown_FP') %>% select(Codon_Id) %>% unique() %>% mutate(comparison = 'Brown_FP')
our_full_cosmic = all_FPs %>% filter(comparison=='COSMIC') %>% select(Codon_Id,comparison) %>% unique()

combined_FPs= all_FPs %>% filter(comparison!='COSMIC') %>% select(Codon_Id,comparison) %>% unique()

all_drivers = bind_rows(combined_TPs,combined_FPs) %>% select(Codon_Id,comparison) %>% unique()
all_kwn_codons = bind_rows(all_drivers,our_full_cosmic) %>% select(Codon_Id,comparison) %>% unique()

# refs
# ref_names = c("cBio_TP", "Chang_TP", "Brown_TP", "Brown_FP", "Mutagene_TP", "Mutagene_FP")
# ref_records_ct = c(nrow(our_cBios), nrow(our_changs), nrow(our_browns), 
#                    nrow(our_brown_FP), nrow(our_mutagenes_TP),
#                    nrow(our_mutagenes_FP))
# ref_ct = as.data.frame(list(comparison = ref_names,
#                             ref_records = ref_records_ct))

# groups
our_TPs = bind_rows(our_cBios,our_mutagenes_TP,our_changs,our_browns,consensus_TPs) %>% 
          mutate(ref_grp = 'TP')
our_FPs = bind_rows(our_mutagenes_FP,our_brown_FP)  %>% mutate(ref_grp = 'FP')
our_TNs = anti_join(data,all_drivers, by='Codon_Id') %>% anti_join(our_full_cosmic, by='Codon_Id')  %>% mutate(ref_grp = 'TN',comparison='UNK')

ref_grp_ct = bind_rows(our_TPs,our_FPs,our_TNs) %>% 
              group_by(ref_grp,comparison) %>% 
              tally(name="ref_records")
label_ct = bind_rows( 
            our_TPs%>% mutate(ref_label = "positives"),
            bind_rows(our_FPs,our_TNs) %>% mutate(ref_label = "negatives")
           ) %>%
            group_by(ref_label) %>%
            tally(name="ref_records")
```

## Validation data
```{r}
all_val_TPs = read.csv('data/2_validation_TPs.csv')

val_cBios = all_val_TPs %>% filter(comparison=='cBio_TP') %>% select(Codon_Id,comparison) %>% unique()
val_changs = all_val_TPs %>% filter(comparison=='Chang_TP') %>% select(Codon_Id,comparison) %>% unique()
val_browns = all_val_TPs %>% filter(comparison=='Brown_TP') %>% select(Codon_Id,comparison) %>% unique()
val_mutagenes_TP = all_val_TPs %>% filter(comparison=='Mutagene_TP') %>% select(Codon_Id,comparison) %>% unique()
val_consensus_TPs = inner_join(
                      inner_join(
                        inner_join(val_cBios,val_changs, by='Codon_Id'),
                        val_browns, by='Codon_Id'),
                      val_mutagenes_TP, by='Codon_Id') %>% mutate(comparison='consensus')

# 55,203 TPs
val_combined_TPs = all_val_TPs %>% select(Codon_Id,comparison) %>% unique()


all_val_FPs = read.csv('data/2_validation_FP.csv')

val_mutagenes_FP = all_val_FPs %>% filter(comparison=='Mutagene_FP') %>% select(Codon_Id,comparison) %>% unique()
val_brown_FP = all_val_FPs %>% filter(comparison=='Brown_FP') %>% select(Codon_Id, comparison) %>% unique() %>% mutate(comparison = 'Brown_FP')
val_full_cosmic = all_val_FPs %>% filter(comparison=='COSMIC') %>% select(Codon_Id,comparison) %>% unique()

val_combined_FPs= all_val_FPs %>% filter(comparison!='COSMIC') %>% select(Codon_Id,comparison) %>% unique()

val_drivers = bind_rows(val_combined_TPs,val_combined_FPs) %>% select(Codon_Id,comparison) %>% unique()

# refs
# ref_names = c("cBio_TP", "Chang_TP", "Brown_TP", "Brown_FP", "Mutagene_TP", "Mutagene_FP")
# val_records_ct = c(nrow(val_cBios), nrow(val_changs), nrow(val_browns), 
#                    nrow(val_brown_FP), nrow(val_mutagenes_TP),
#                    nrow(val_mutagenes_FP))
# val_ref_ct = as.data.frame(list(comparison = ref_names,
#                             ref_records = val_records_ct))

# groups
val_TPs = bind_rows(val_cBios,val_mutagenes_TP,val_consensus_TPs,val_changs,val_browns) %>% 
            mutate(ref_grp = 'TP')
val_FPs = bind_rows(val_mutagenes_FP,val_brown_FP)  %>% mutate(ref_grp = 'FP')
val_TNs = anti_join(val_data,val_drivers, by='Codon_Id') %>% anti_join(val_full_cosmic, by='Codon_Id')  %>% mutate(ref_grp = 'TN',comparison='UNK')

val_ref_ct = bind_rows(val_TPs,val_FPs,val_TNs) %>% 
            group_by(ref_grp,comparison) %>% 
            tally(name="ref_records")

val_negs = bind_rows(val_FPs,val_TNs) %>% mutate(ref_label="negatives")
val_pos = val_TPs %>% mutate(ref_label="positives")
val_label_ct = bind_rows(val_pos,val_negs) %>% 
            group_by(ref_label) %>% 
            tally(name="ref_records")
            

val_ref_ct
val_label_ct
```

## ref comparison fns
```{r}
# compare_results = function(ref_table, qval_table, return_table=F) {
#   overlap_df = semi_join(qval_table,ref_table, by="Codon_Id")
#   return(overlap_df)
# }
compare_dfs = function(df){
  cBio_results = df %>% semi_join(our_cBios, by="Codon_Id") %>% mutate(comparison='cBio_TP')
  chang_results = df %>% semi_join(our_changs, by="Codon_Id") %>% mutate(comparison='Chang_TP')
  brown_TP_results = df %>% semi_join(our_browns, by="Codon_Id") %>% mutate(comparison='Brown_TP')
  brown_FP_results = df %>% semi_join(our_brown_FP, by="Codon_Id") %>% mutate(comparison='Brown_FP')
  mutagene_TP_results = df %>% semi_join(our_mutagenes_TP, by="Codon_Id") %>% mutate(comparison='Mutagene_TP')
  mutagene_FP_results = df %>% semi_join(our_mutagenes_FP, by="Codon_Id") %>% mutate(comparison='Mutagene_FP')
  cosmic_results = df %>% anti_join(our_full_cosmic, by="Codon_Id") %>% mutate(comparison='UNK')
  consensus_results = df %>% semi_join(consensus_TPs, by='Codon_Id')  %>% mutate(comparison='consensus')
  
  comb_results = bind_rows(cBio_results,chang_results,
                               brown_TP_results,brown_FP_results,
                               mutagene_TP_results,mutagene_FP_results) 
  
  TP_results = bind_rows(cBio_results, mutagene_TP_results, consensus_results,
                         chang_results, brown_TP_results) %>% 
                mutate(ref_grp = 'TP')
  
  FP_results = bind_rows(mutagene_FP_results,brown_FP_results) %>% 
                mutate(ref_grp = 'FP')

  TN_results = anti_join(df,comb_results, by='Codon_Id') %>%
                semi_join(cosmic_results, by='Codon_Id') %>%
                mutate(comparison='UNK',
                       ref_grp = 'TN')
  all_results = bind_rows(TP_results, FP_results, TN_results) %>%
                mutate(comparison = factor(comparison),
                       ref_grp = factor(ref_grp,
                                         levels=c("FP","TP","TN"))
                )
  div_results = bind_rows( 
            TP_results%>% mutate(ref_label = "positives"),
            bind_rows(TN_results,FP_results) %>% mutate(ref_label = "negatives")
           )
  
  return(list(TP = TP_results, FP = FP_results, 
              TN = TN_results, 
              all = all_results, div = div_results))
}

compare_vals = function(df){
  cBio_results = df %>% semi_join(val_cBios, by="Codon_Id") %>% mutate(comparison='cBio_TP')
  chang_results = df %>% semi_join(val_changs, by="Codon_Id") %>% mutate(comparison='Chang_TP')
  brown_TP_results = df %>% semi_join(val_browns, by="Codon_Id") %>% mutate(comparison='Brown_TP')
  brown_FP_results = df %>% semi_join(val_brown_FP, by="Codon_Id") %>% mutate(comparison='Brown_FP')
  mutagene_TP_results = df %>% semi_join(val_mutagenes_TP, by="Codon_Id") %>% mutate(comparison='Mutagene_TP') 
  mutagene_FP_results = df %>% semi_join(val_mutagenes_FP, by="Codon_Id") %>% mutate(comparison='Mutagene_FP')
  cosmic_results = df %>% anti_join(val_full_cosmic, by="Codon_Id") %>% mutate(comparison='UNK')
  consensus_results = df %>% semi_join(val_consensus_TPs, by='Codon_Id')  %>% mutate(comparison='consensus')
  
  comb_results = bind_rows(cBio_results,chang_results,
                               brown_TP_results,brown_FP_results,
                               mutagene_TP_results,mutagene_FP_results) 
  
  TP_results = bind_rows(cBio_results, mutagene_TP_results, consensus_results,
                         chang_results,brown_TP_results) %>% 
                mutate(ref_grp = 'TP')
  
  FP_results = bind_rows(mutagene_FP_results,brown_FP_results) %>% 
                mutate(ref_grp = 'FP')

  TN_results = anti_join(df,comb_results, by='Codon_Id') %>%
                semi_join(cosmic_results, by='Codon_Id') %>%
                mutate(comparison='UNK',
                       ref_grp = 'TN')
  all_results = bind_rows(TP_results,
                              FP_results, TN_results) %>%
                mutate(comparison = factor(comparison),
                       ref_grp = factor(ref_grp,
                                         levels=c("FP","peer","TP","TN"))
                )

  val_results = bind_rows( 
            TP_results%>% mutate(ref_label = "positives"),
            bind_rows(TN_results,FP_results) %>% mutate(ref_label = "negatives")
           )
  
  return(list(TP = TP_results, FP = FP_results, 
              TN = TN_results, 
              all = all_results, val = val_results))
}

ref_grp_perc_overlap = function(result_df) return(full_join(result_df,ref_grp_ct, by=c('ref_grp','comparison')) %>% mutate(perc_overlap = n/ref_records, ref_grp=factor(ref_grp, levels=c("FP","TP","TN"))))

label_perc_overlap = function(result_df) return(full_join(result_df,label_ct, by=c('ref_label')) %>% mutate(perc_overlap = n/ref_records, ref_label=factor(ref_label, levels=c("negatives","positives"))))

val_ref_perc_overlap = function(result_df) return(full_join(result_df,val_ref_ct, by=c('ref_grp','comparison')) %>% mutate(perc_overlap = n/ref_records))

ref_labels = c("False Positive","True Positive","True Negative")
names(ref_labels) = c("FP","TP","TN")
```
## GENIE patterns
```{r}
data %>% filter(Observations < 10) %>% mutate(mu_diff = obs.mu-E.mu) %>% arrange(desc(mu_diff), desc(E.mu))
```
```{r}
eg_codon = data %>% filter(Codon_Id=='ATM_G2023') %>% select(c(obs.mu,E.mu, Observations)) #TSC1_E889

x = seq(0,20,by=1)
y_E = dbinom(x,total_patients,eg_codon$E.mu)
y_O = dbinom(x,total_patients,eg_codon$obs.mu)
plot(x,y_E)#, ylim=c(0,.5),type="l")
lines(x,y_O)
```
```{r}
eg_codon = data %>% filter(Codon_Id=='ATM_G2023') %>% select(c(obs.mu,E.mu, Observations)) #TSC1_E889

x = seq(0,15,by=1)
eg_df = data.frame(x=x, E_ct=dbinom(x,total_patients,eg_codon$E.mu),
                    O_ct=dbinom(x,total_patients,eg_codon$obs.mu)) %>%
          rowwise() %>%
          mutate(min_y = min(E_ct,O_ct)) %>%
          pivot_longer(c(E_ct,O_ct), names_to = "cohort", values_to = "probability")
          
ggplot(eg_df) +
    geom_bar(data=subset(eg_df,x>=0 & x<=7 & probability<.03),aes(x=x,y=probability,fill=cohort), position="dodge", stat="identity", alpha=.5) +
    geom_bar(aes(x=x,y=probability,fill=cohort), position="dodge", stat="identity", alpha=.3) +
    geom_line(aes(x=x,y=probability,color=cohort),show.legend=F) +
    geom_vline(xintercept = total_patients * eg_codon$E.mu, 
                color = "red") +
    geom_vline(xintercept = eg_codon$Observations, 
                color = "blue") +
    theme_classic() +
    coord_cartesian(xlim=c(0,13), ylim=c(0,.25)) +
    annotate("text", x = 7, y = .23, label = "Effect size") +
    annotate("segment", x = eg_codon$Observations, 
             xend = total_patients * eg_codon$E.mu, 
             y = .22, yend = .22,
             arrow = arrow(length = unit(2, "mm"))) +
    annotate("segment", xend = eg_codon$Observations, 
             x = total_patients * eg_codon$E.mu, 
             y = .22, yend = .22,
             arrow = arrow(length = unit(2, "mm"))) +
    theme(axis.title.y = element_blank()) +
    xlab("Number of Mutations") +
    scale_fill_discrete(name = "Population", labels = c("Non-cancerous", "Cancerous"))
ggsave("plots/Report_effect_size.pdf",width = 15, height = 7, units = "cm")
```

## Ref patterns: mutability
```{r}
pval_df = data_pvals %>% select(c(Codon_Id,obs.mu,E.mu,exact_bin))

ref_mu = compare_dfs(pval_df)$all %>%
              pivot_longer(c(obs.mu,E.mu),
                           names_to = "measure",
                           values_to = "mu") %>%
              mutate(ref_grp = factor(ref_grp,
                                         levels=c("FP","TP","TN")))

measure_labels = c("GENIE", "Baseline")
names(measure_labels) = c("obs.mu","E.mu")
ref_labels = c("False Positive","True Positive","True Negative")
names(ref_labels) = c("FP","TP","TN")

ggplot(ref_mu, 
       aes(x=comparison,y=mu,color=measure)) +
  geom_boxplot(show.legend=T) +
  facet_grid(~ref_grp,
             labeller = labeller(ref_grp = ref_labels),
             scale="free",
             space = "free_x") +
  scale_x_discrete(labels=c("cBio_TP" = "Chang True Positives", 
                            "Chang_TP" = "Chang Predictions",
                            "consensus" = "Consensus Positives",
                            "Brown_TP" = 'Brown "Driver"',
                            "Brown_FP" = 'Brown "Passenger"',
                            "Mutagene_TP" = 'Li "Non-netural"',
                            "Mutagene_FP" = 'Li "Netural"',
                            "UNK" = "No mentions"
                            )) +
  scale_color_discrete(name = "", labels = c("Baseline data", "GENIE data")) +
  theme(axis.text.x = element_text(angle=45,hjust=1),
        axis.title.x = element_blank(),
        legend.position="top"
        ) +
  ylab("log(Mutability)") +
  scale_y_log10()
ggsave("plots/Report_ref_mu.pdf")
```

## Ref patterns: (Null) Hypothesis testing
```{r}
ref_grp_perc_overlap = function(result_df) return(full_join(result_df,ref_grp_ct, by=c('ref_grp','comparison')) %>% mutate(perc_overlap = n/ref_records, ref_grp=factor(ref_grp, levels=c("FP","TP","TN"))))
# ref_perc_overlap = function(result_df) return(full_join(result_df,ref_ct, by='comparison') %>% mutate(perc_overlap = n/ref_records))

# htest_results = read.csv('data/2_qval_CI_test_results.csv')

BF_q_discoveries = htest_results %>% filter(BF_q_reject==T) %>% mutate(disc_method = "BF_q")
BY_q_discoveries = htest_results %>% filter(BY_q_reject==T)  %>% mutate(disc_method = "BY_q")
BF_CI_discoveries = htest_results %>% filter(BF_CI_reject==T)  %>% mutate(disc_method = "BF_CI")
BY_CI_discoveries = htest_results %>% filter(BY_CI_reject==T)  %>% mutate(disc_method = "BY_CI")

all_discoveries = bind_rows(BF_q_discoveries,BY_q_discoveries,BF_CI_discoveries,BY_CI_discoveries) %>%
                    mutate(disc_method = factor(disc_method,
                                                   levels=c('BF_CI','BY_CI','BF_q','BY_q')))

all_discoveries %>% group_by(disc_method) %>% tally()

grp_results = compare_dfs(all_discoveries)$all %>%
                mutate(ref_grp = as.factor(ref_grp)) %>%
                group_by(disc_method,ref_grp,comparison) %>% tally()
# ref_results = compare_dfs(all_discoveries)$all %>%
#                 mutate(comparison = as.factor(comparison)) %>%
#                 group_by(disc_method,comparison, .drop=F) %>% tally()

comp_df = ref_grp_perc_overlap(grp_results)
# ref_comp_df = ref_perc_overlap(ref_results)

ref_labels = c("False Positive","True Positive","True Negative")
names(ref_labels) = c("FP","TP","TN")


ggplot(comp_df, aes(x=comparison,y=perc_overlap,fill=disc_method)) +
  geom_bar(aes(fill=disc_method),
          position="dodge", stat="identity", alpha = .8) +
  scale_x_discrete(labels=c("cBio_TP" = "Chang True Positives", 
                            "Chang_TP" = "Chang Predictions",
                            "consensus" = "Consensus Positives",
                            "Brown_TP" = 'Brown "Driver"',
                            "Brown_FP" = 'Brown "Passenger"',
                            "Mutagene_TP" = 'Li "Non-netural"',
                            "Mutagene_FP" = 'Li "Netural"',
                            "UNK" = "No mentions")) +
  facet_grid(~ref_grp, 
             labeller = labeller(ref_grp = ref_labels),
             scale = "free",space="free") +
  theme(axis.text.x = element_text(angle=45,hjust=1),
        axis.title.x = element_blank(),
        legend.position="top"
        ) +
  ylab("Proportion Identified") +
  scale_fill_discrete(name = "", 
                      labels = c("Bonferroni Confidence Interval", 
                                 "B-Y Confidence Interval", 
                                 "Bonferroni q-value","B-Y q-value"))
# ggsave("plots/Report_HT_results.pdf")
```
### Compare pattern: HTesting
```{r}
ref_sig_val = compare_dfs(htest_results)$all %>%
              mutate(lg_BF_CI = log(BF_distance),
                     lg_BY_CI = log(BY_distance)
                     ) %>%
              pivot_longer(c(BF_qval,lg_BF_CI,BY_qval, lg_BY_CI), 
                           names_to = "disc_method",
                           values_to = "disc_val") %>%
              mutate(ref_grp = factor(ref_grp,
                                         levels=c("FP","TP","TN")),
                     disc_method = factor(disc_method,
                                          levels=c('lg_BF_CI','lg_BY_CI','BF_qval','BY_qval')),
                     measure = ifelse(disc_method=="BF_qval"|
                                      disc_method=="BY_qval",
                                      "p-value","Confidence Interval")) #,
                     # disc_method = factor(disc_method,
                     #                               levels=c('BF_CI','BY_CI','BF_qval','BY_qval')))
              # pivot_longer(c(BF_qval,BY_qval), 
              #              names_to = "q_method",
              #              values_to = "q_val") %>%
              # pivot_longer(c(BF_CI, BY_CI),
              #              names_to = "CI_method",
              #              values_to = "CI_val") %>%

# measure_labels = c("FWER", "FDR")
# names(measure_labels) = c("BF_qval","BY_qval")
ref_labels = c("False Positive","True Positive","True Negative")
names(ref_labels) = c("FP","TP","TN")



ggplot(ref_sig_val) +
  geom_boxplot(aes(x=comparison,y=disc_val,color=disc_method)) +
  facet_grid(measure~ref_grp,
             labeller = labeller(ref_grp = ref_labels),
             scale="free",
             space = "free_x") +
  scale_x_discrete(labels=c("cBio_TP" = "Chang True Positives", 
                            "Chang_TP" = "Chang Predictions",
                            "consensus" = "Consensus Positives",
                            "Brown_TP" = 'Brown "Driver"',
                            "Brown_FP" = 'Brown "Passenger"',
                            "Mutagene_TP" = 'Li "Non-netural"',
                            "Mutagene_FP" = 'Li "Netural"',
                            "UNK" = "No mentions"
                            )) +
  theme(axis.text.x = element_text(angle=45,hjust=1),
        axis.title.x = element_blank(),
        axis.title.y = element_text(size=10),
        legend.position="top"
        ) +
  ylab("       adjusted p-value            log(distance above C.I.)") +
  scale_color_discrete(name = "", 
                      labels = c("Bonferroni Confidence Interval", 
                                 "B-Y Confidence Interval", 
                                 "Bonferroni q-value","B-Y q-value"))
   
ggsave("plots/Report_ref_qCI.pdf", height = 15, units="cm")

# ref_sig_val %>% filter(ref_grp == 'TN') %>% arrange(disc_val)
```
## Discriminatory power: alpha
```{r}
filter_alpha= function(crit_a) {
  filtered_data = htest_results %>% filter(BF_qval < exp(crit_a))
  if (!is.null(nrow(compare_dfs(filtered_data)$div))) {
    record_overlap = compare_dfs(filtered_data)$div %>%
                          mutate(ref_label = as.factor(ref_label)) %>%
                          group_by(ref_label) %>% tally()
    record_overlap_perc = label_perc_overlap(record_overlap) %>%
                          replace(is.na(.), 0)
  } else {return(data.frame())}

  return(record_overlap_perc)
}

alpha = seq(-800,0,by=.1) #c(seq(-800,0,by=.1),seq(.01,1,by=.01))

alpha_table = data.frame(neg_rate=numeric(length(alpha)), pos_rate=numeric(length(alpha)))
for (i in 1:length(alpha)){
  if (i %% 50 == 0){
    print(alpha[i])
  }
    results = filter_alpha(alpha[i])
    if (nrow(results)<1){
      next
    }
    alpha_table[i,] = results$perc_overlap
}

alpha_results = bind_cols(alpha_table,list(a=alpha))
# write.csv(alpha_results,'data/divergence_alpha_BF.csv',row.names=F)
# write.csv(alpha_results,'data/divergence_alpha_BY.csv',row.names=F)
# alpha_results = read.csv('data/divergence_alpha_BF.csv')
alpha_results = read.csv('data/divergence_alpha_BY.csv')

a_divergence = alpha_results %>% mutate(rate_diff = abs(pos_rate-neg_rate)) %>% arrange(desc(rate_diff)) %>% top_n(1)

alpha_roc =  alpha_results%>%
              filter(neg_rate>0, pos_rate>0) %>%
              pivot_longer(c(pos_rate,neg_rate),
                              names_to = "label",
                              values_to = "rate"
                              ) %>%
              mutate(label = factor(label,levels=c("pos_rate","neg_rate")))

ggplot(alpha_roc, aes(x=a,y=rate,color=label)) +
  geom_line() +
  geom_vline(xintercept = a_divergence$a, linetype="dashed")+
  scale_color_discrete(name = "",
                      labels = c("Potential Positives","Potential Negatives")) +
  theme(legend.position="top") +
  coord_cartesian(xlim = c(-50,0), ylim=c(0,1)) +
  annotate("text", x = a_divergence$a-7, y = .45, 
           label = paste0("log(adjusted p) = ", round(a_divergence$a,3))) +
  annotate("text", x = a_divergence$a-6, y = .4, 
           label = paste0("separation = ", round(a_divergence$rate_diff,3))) +
  xlab("log(B-Y adjusted p-value)") + ylab("Proportion")
  # xlab("log(Bonferroni adjusted p-value)") + ylab("Proportion")

# ggsave('plots/Report_div_a_BF.pdf', height=11,units="cm")
ggsave('plots/Report_div_a_BY.pdf', height=11,units="cm")

```

## Ref patterns: alpha v. beta
```{r}
std_power = function(h) return(pwr.p.test(h=h, n=total_patients, 
                                          sig.level=.01,
                                          alternative="greater")$power)

# htest_results = read.csv('data/2_qval_CI_test_results.csv')

# BY_q_discoveries = htest_results %>% filter(BY_q_reject==T)  %>% mutate(disc_method = "BY_q")
# BF_CI_discoveries = htest_results %>% filter(BF_CI_reject==T)  %>% mutate(disc_method = "BF_CI")
# 
# extrem_discoveries = bind_rows(BY_q_discoveries,BF_CI_discoveries) %>%
#                     mutate(disc_method = factor(disc_method,
                                                   # levels=c('BF_CI','BY_q')))


pwr_df = htest_results %>%
          select(c(Codon_Id,obs.mu,E.mu,BF_qval,BY_qval)) %>%
          mutate(effect_size_h = 2*(asin(sqrt(obs.mu)) - asin(sqrt(E.mu))),
                 power = std_power(effect_size_h),
                  beta = 1- power
          )
                 # BYq_cohen_power = std_power(effect_size_h, max(BY_q_discoveries$exact_bin)),
                 # BFCI_cohen_power = std_power(effect_size_h, max(BF_CI_discoveries$exact_bin)),
                 # BYq_cohen_beta = 1-BYq_cohen_power,
                 # BFCI_cohen_beta = 1-BFCI_cohen_power,
                 # )
          

# write.csv(pwr_df, 'data/2_power_calcs.csv',row.names = F)

ref_pwr = compare_dfs(pwr_df)$all %>%
            mutate(ref_grp = factor(ref_grp,levels=c("FP","TP","TN"))) #%>%
            # pivot_longer(c(BYq_cohen_beta,BFCI_cohen_beta),
            #              names_to = "sig_method",
            #              values_to = "beta")

comparison_labels = c("cBio_TP" = "Chang True Positives", 
                      "Chang_TP" = "Chang Predictions",
                      "consensus" = "Consensus Positives",
                      "Brown_TP" = 'Brown "Driver"',
                      "Brown_FP" = 'Brown "Passenger"',
                      "Mutagene_TP" = 'Li "Non-netural"',
                      "Mutagene_FP" = 'Li "Netural"',
                      "UNK" = "No mentions"
                      )
ref_labels = c("False Positive","True Positive","True Negative")
names(ref_labels) = c("FP","TP","TN")

ggplot(ref_pwr, aes(x=comparison,y=log(beta),color=comparison)) +
  geom_boxplot(show.legend = F)+
  # geom_hline(yintercept=log(.2),linetype="dashed") +
  facet_grid(~ref_grp,
             labeller = labeller(ref_grp = ref_labels),
             scale="free",
             space = "free_x") +
  scale_x_discrete(labels=c("cBio_TP" = "Chang True Positives", 
                            "Chang_TP" = "Chang Predictions",
                            "consensus" = "Consensus Positives",
                            "Brown_TP" = 'Brown "Driver"',
                            "Brown_FP" = 'Brown "Passenger"',
                            "Mutagene_TP" = 'Li "Non-netural"',
                            "Mutagene_FP" = 'Li "Netural"',
                            "UNK" = "No mentions"
                            )) +
  theme(axis.text.x = element_text(angle=45,hjust=1),
        axis.title.x = element_blank(),
        ) +
  ylab("log(Type II error)")
ggsave("plots/Report_ref_power.pdf")
```
```{r}
high_power_BF = pwr_df %>% filter(beta < max(b_divergence$b), BF_qval<exp(-60))
high_power_BY = pwr_df %>% filter(beta < max(b_divergence$b), BY_qval<exp(-60))
       
high_power_BF_overlap = compare_dfs(high_power_BF)$all %>%
                      group_by(ref_grp,comparison) %>%
                      tally()
high_power_BY_overlap = compare_dfs(high_power_BY)$all %>%
                      group_by(ref_grp,comparison) %>%
                      tally()

high_power_BF_perc = ref_grp_perc_overlap(high_power_BF_overlap) %>% 
                      replace(is.na(.), 0) %>% 
                      mutate(disc_method="BF")
high_power_BY_perc = ref_grp_perc_overlap(high_power_BY_overlap) %>% 
                      replace(is.na(.), 0) %>% 
                      mutate(disc_method="BY")

just_a_perc = comp_df %>% filter(disc_method == "BF_q") #| disc_method == "BY_q")

high_power_perc = bind_rows(high_power_BF_perc,just_a_perc) %>%
                    mutate(disc_method = factor(disc_method,
                                                levels=c("BF_q","BF"))) #,"BY_q","BY")))

ggplot(high_power_perc, aes(x=comparison,y=perc_overlap)) +
  geom_bar(aes(fill=disc_method),
          position="dodge", stat="identity", alpha = .8) +
  # geom_text(position = position_dodge(width = 0.9),
  #           vjust = 3) +
  scale_x_discrete(labels=c("cBio_TP" = "Chang True Positives", 
                            "Chang_TP" = "Chang Predictions",
                            "consensus" = "Consensus Positives",
                            "Brown_TP" = 'Brown "Driver"',
                            "Brown_FP" = 'Brown "Passenger"',
                            "Mutagene_TP" = 'Li "Non-netural"',
                            "Mutagene_FP" = 'Li "Netural"',
                            "UNK" = "No mentions")) +
  facet_grid(~ref_grp, 
             labeller = labeller(ref_grp = ref_labels),
             scale = "free", space="free"
             ) +
  theme(axis.text.x = element_text(angle=45,hjust=1),
        axis.title.x = element_blank(),
        legend.position="top"
        ) +
  ylab("Proportion Identified") +
  scale_fill_discrete(name = "", 
                      labels = c("Type I error only (.01)", 
                                 "Type I & Type II errors")) 

# ggsave("plots/Report_aVb_perc_BF.pdf")

```
```{r}
pixel_size = c(50,.01)

aXb_ref = ref_pwr %>% pivot_longer(c(BF_qval,BY_qval),
                         names_to = "metric",
                         values_to = "alpha") %>%
          filter(beta>0)

ggplot(aXb_ref, aes(x=log(alpha), y=log(beta), color=metric)) +
  # geom_bin2d(binwidth = pixel_size) +
  geom_point(alpha=.3) +
  facet_wrap(~ref_grp,
             labeller = labeller(ref_grp = ref_labels, comparison = comparison_labels)) +
  xlab("log(Type I error)") + ylab("log(Type II error)") +
  theme(legend.position="top") +
  scale_color_discrete(name = "", 
                      labels = c("Bonferroni adjusted p","B-Y adjusted p"))  +
  # geom_vline(xintercept=-60, linetype="dashed") +
  # geom_hline(yintercept=-10, linetype="dashed") #+
  # coord_cartesian(xlim = c(-800,0), ylim=c(-8000,0))
ggsave("plots/Report_ref_aVb.pdf")
```

## Discriminatory power: beta
```{r}
filter_beta= function(crit_b) {
  filtered_data = pwr_df %>% filter(beta < exp(crit_b))
  if (!is.null(nrow(compare_dfs(filtered_data)$div))) {
    record_overlap = compare_dfs(filtered_data)$div %>%
                          mutate(ref_label = as.factor(ref_label)) %>%
                          group_by(ref_label) %>% tally()
    record_overlap_perc = label_perc_overlap(record_overlap) %>%
                          replace(is.na(.), 0)
  } else {return(data.frame())}

  return(record_overlap_perc)
}

beta = seq(-40,0,by=.01) #c(seq(0,.002,by=1e-5),seq(.01,1,by=.01))

beta_table = data.frame(neg_rate=numeric(length(beta)), pos_rate=numeric(length(beta)))
for (i in 1:length(beta)){
  if (i %% 50 == 0){
    print(beta[i])
  }
    results = filter_beta(beta[i])
    if (nrow(results)<1){
      next
    }
    beta_table[i,] = results$perc_overlap
}

beta_results = bind_cols(beta_table,list(b=beta))
# write.csv(alpha_results,'data/divergence_beta.csv',row.names=F)
beta_results = read.csv('data/divergence_beta.csv')
b_divergence = beta_results %>% mutate(rate_diff = abs(pos_rate-neg_rate)) %>% arrange(desc(rate_diff)) %>% top_n(1)

beta_roc =  beta_results%>%
          pivot_longer(c(pos_rate,neg_rate),
                          names_to = "label",
                          values_to = "rate"
                          ) %>%
          mutate(label = factor(label,levels=c("pos_rate","neg_rate")))

ggplot(beta_roc, aes(x=b,y=rate,color=label)) +
  geom_line() +
  geom_vline(xintercept = b_divergence$b, linetype="dashed")+
  scale_color_discrete(name = "",
                      labels = c("Potential Positives","Potential Negatives")) +
  theme(legend.position="top") + xlab("log(Type II error)") +
  ylab("Proportion") +
  coord_cartesian(xlim = c(-40,0), ylim=c(0,1)) +
  annotate("text", x = b_divergence$b-4.5, y = .45, 
           label = paste0("log(error) = ", b_divergence$b)) +
  annotate("text", x = b_divergence$b-4.5, y = .4, 
           label = paste0("separation = ", round(b_divergence$rate_diff,3)))
ggsave('plots/Report_div_b.pdf')
```

## Check results with validation set
note: even at .01 q-val threshold, we only get 87 results. If we set beta at .2, down to 37 results. @ max divergence threshold, 0 records.
```{r}
# val_htest = read.csv('data/2_qval_validation_results.csv')
# 
# val_sig_results = val_htest #%>%
#                     # filter(BF_qval<a_divergence$a) #, BY_qval<a_divergence$a)
# 
# val_pwr = val_sig_results %>%
#           select(c(Codon_Id,obs.mu,E.mu,BF_qval,BY_qval)) %>%
#           mutate(effect_size_h = 2*(asin(sqrt(obs.mu)) - asin(sqrt(E.mu))),
#                  power = std_power(effect_size_h),
#                   beta = 1- power
#           ) %>% filter(beta < max(b_divergence$b))
# 
# val_ht_results = compare_vals(val_pwr)$val %>%
#                 mutate(ref_grp = as.factor(ref_grp)) %>%
#                 group_by(ref_grp,comparison) %>% tally()
# 
# val_ht_overlap = val_ref_perc_overlap(val_ht_results) %>%
#                   replace(is.na(.), 0)
# 
# ggplot(val_ht_overlap, aes(x=comparison,y=perc_overlap,fill=comparison,label=n)) +
#   geom_col(show.legend = F, alpha=.8) +
#   geom_text(position = position_dodge(width = 0.9),
#             vjust = 3) +
#   scale_x_discrete(labels=c("cBio_TP" = "Chang True Positives", 
#                             "Chang_TP" = "Chang Predictions",
#                             "consensus" = "Consensus Positives",
#                             "Brown_TP" = 'Brown "Driver"',
#                             "Brown_FP" = 'Brown "Passenger"',
#                             "Mutagene_TP" = 'Li "Non-netural"',
#                             "Mutagene_FP" = 'Li "Netural"',
#                             "UNK" = "No mentions")) +
#   facet_grid(~ref_grp, 
#              labeller = labeller(ref_grp = ref_labels),
#              scale = "free", space="free"
#              ) +
#   theme(axis.text.x = element_text(angle=45,hjust=1),
#         axis.title.x = element_blank(),
#         legend.position="top"
#         ) +
#   ylab("Proportion Identified")
```

## Bayesian binom test
```{r}
# std_power = function(h) return(pwr.p.test(h=h, n=total_patients, 
#                                           sig.level=.01,
#                                           alternative="greater")$power)

bayes_discoveries = bayes_bin_results %>% 
                      mutate(bayes_p = exp(log_score)) %>%
                      filter(bayes_p < .01)
       
bayes_disc_overlap = compare_dfs(bayes_discoveries)$all %>%
                      group_by(comparison,ref_grp) %>%
                      tally()



bayes_perc_df = ref_grp_perc_overlap(bayes_disc_overlap)


ggplot(bayes_perc_df, aes(x=comparison,y=perc_overlap,fill=comparison)) +
  geom_col(show.legend = F, alpha=.8) +
  scale_x_discrete(labels=c("cBio_TP" = "Chang True Positives", 
                            "Chang_TP" = "Chang Predictions",
                            "consensus" = "Consensus Positives",
                            "Brown_TP" = 'Brown "Driver"',
                            "Brown_FP" = 'Brown "Passenger"',
                            "Mutagene_TP" = 'Li "Non-netural"',
                            "Mutagene_FP" = 'Li "Netural"',
                            "UNK" = "No mentions")) +
  facet_grid(~ref_grp, 
             labeller = labeller(ref_grp = ref_labels),
             scale = "free",space="free") +
  theme(axis.text.x = element_text(angle=45,hjust=1),
        axis.title.x = element_blank(),
        legend.position="top"
        ) +
  ylab("Proportion Identified")

new_comp_df = bind_rows(comp_df,bayes_perc_df %>% 
                          mutate(disc_method = "Bayes")) %>%
                  mutate(disc_method = factor(disc_method,
                                          levels=c('BF_CI','BY_CI','BF_q','BY_q','Bayes'))
                        )

ggplot(new_comp_df, aes(x=comparison,y=perc_overlap)) +
  geom_bar(aes(fill=disc_method),
          position="dodge", stat="identity", alpha = .8) +
  scale_x_discrete(labels=c("cBio_TP" = "Chang True Positives", 
                            "Chang_TP" = "Chang Predictions",
                            "consensus" = "Consensus Positives",
                            "Brown_TP" = 'Brown "Driver"',
                            "Brown_FP" = 'Brown "Passenger"',
                            "Mutagene_TP" = 'Li "Non-netural"',
                            "Mutagene_FP" = 'Li "Netural"',
                            "UNK" = "No mentions")) +
  facet_grid(~ref_grp, 
             labeller = labeller(ref_grp = ref_labels),
             scale = "free", space="free") +
  theme(axis.text.x = element_text(angle=45,hjust=1),
        axis.title.x = element_blank(),
        legend.position="top"
        ) +
  ylab("Proportion Identified") +
  scale_fill_discrete(name = "", 
                      labels = c("Bonferroni C.I.", "B-Y C.I.", 
                                 "Bonferroni q-value","B-Y q-value",
                                 "Bayes p-value"))
ggsave('plots/Report_bayes_test_ref.pdf',height=12,units = "cm")
```

```{r}
bayes_pwr_df = compare_dfs(bayes_discoveries)$all %>%
                  mutate(effect_size_h = 2*(asin(sqrt(obs.mu)) - asin(sqrt(E.mu))),
                         power = std_power(effect_size_h),
                         beta = 1-power,
                         ref_grp = factor(ref_grp,levels=c("FP","TP","TN"))
                  )

ggplot(bayes_pwr_df, aes(x=log(bayes_p), y=log(beta))) +
  # geom_bin2d(binwidth = pixel_size) +
  geom_point(alpha=.3) +
  facet_wrap(~ref_grp,
             labeller = labeller(ref_grp = ref_labels, comparison = comparison_labels)) +
  xlab("log(Type I error)") + ylab("log(Type II error)") +
  scale_color_discrete(labels=c("cBio_TP" = "Chang True Positives",
                            "Chang_TP" = "Chang Predictions",
                            "consensus" = "Consensus Positives",
                            "Brown_TP" = 'Brown "Driver"',
                            "Brown_FP" = 'Brown "Passenger"',
                            "Mutagene_TP" = 'Li "Non-netural"',
                            "Mutagene_FP" = 'Li "Netural"',
                            "UNK" = "No mentions"
                            ))
```

## Cross-sectional metrics
```{r}
val_perc_label = function(result_df) return(full_join(result_df,val_label_ct, by=c('ref_label')) %>% mutate(perc_overlap = n/ref_records))

val_risk_ES_data = val_data %>%
                    mutate(risk_ratio = obs.mu/E.mu,
                           effect_size_h = 2*(asin(sqrt(obs.mu)) - asin(sqrt(E.mu))))

filter_rate = function(crit_risk,crit_ES) {
  filtered_data = val_risk_ES_data %>% filter(risk_ratio > crit_risk, effect_size_h > -exp(crit_ES))
  record_overlap = compare_vals(filtered_data)$val %>%
                        mutate(ref_label = as.factor(ref_label)) %>%
                        group_by(ref_label) %>% tally()
  record_overlap_perc = val_perc_label(record_overlap) %>%
                          replace(is.na(.), 0)
                          
  return(record_overlap_perc)
}
```

## Effect Size
```{r}
ES_df = data_pvals %>%
          mutate(effect_size_h = 2*(asin(sqrt(obs.mu)) - asin(sqrt(E.mu))))

ref_ES = compare_dfs(ES_df)$all %>%
            mutate(ref_grp = factor(ref_grp,levels=c("FP","TP","TN"))) #%>%
            # pivot_longer(c(BYq_cohen_beta,BFCI_cohen_beta),
            #              names_to = "sig_method",
            #              values_to = "beta")

ggplot(ref_ES, aes(x=comparison,y=log(effect_size_h),color=comparison)) +
  geom_boxplot(show.legend = F)+
  facet_grid(~ref_grp,
             labeller = labeller(ref_grp = ref_labels),
             scale="free",
             space = "free_x") +
  scale_x_discrete(labels=c("cBio_TP" = "Chang True Positives", 
                            "Chang_TP" = "Chang Predictions",
                            "consensus" = "Consensus Positives",
                            "Brown_TP" = 'Brown "Driver"',
                            "Brown_FP" = 'Brown "Passenger"',
                            "Mutagene_TP" = 'Li "Non-netural"',
                            "Mutagene_FP" = 'Li "Netural"',
                            "UNK" = "No mentions"
                            )) +
  theme(axis.text.x = element_text(angle=45,hjust=1),
        axis.title.x = element_blank(),
        ) #+
  # geom_hline(yintercept=-4.5,linetype="dashed")
ggsave('plots/Report_ref_effect_size.pdf')

high_ES = ES_df %>% filter(effect_size_h>exp(-4.5)) %>% select(Codon_Id) %>% unique()

sig_ES_overlap = compare_dfs(high_ES)$all %>%
                      group_by(comparison,ref_grp) %>%
                      tally()

sig_ES_perc = ref_grp_perc_overlap(sig_ES_overlap)

# ggplot(sig_ES_perc, aes(x=comparison,y=perc_overlap,fill=comparison)) +
#   geom_col(show.legend = F, alpha=.8) +
#   scale_x_discrete(labels=c("cBio_TP" = "Chang True Positives", 
#                             "Chang_TP" = "Chang Predictions",
#                             "consensus" = "Consensus Positives",
#                             "Brown_TP" = 'Brown "Driver"',
#                             "Brown_FP" = 'Brown "Passenger"',
#                             "Mutagene_TP" = 'Li "Non-netural"',
#                             "Mutagene_FP" = 'Li "Netural"',
#                             "UNK" = "No mentions")) +
#   facet_grid(~ref_grp, 
#              labeller = labeller(ref_grp = ref_labels),
#              scale = "free",space="free") +
#   theme(axis.text.x = element_text(angle=45,hjust=1),
#         axis.title.x = element_blank(),
#         legend.position="top"
#         ) +
#   ylab("Proportion Identified")
```
## Discriminatory power: Effect Size
```{r}
filter_es1= function(crit_es1) {
  filtered_data = ES_df %>% filter(effect_size_h < exp(crit_es1))
  if (!is.null(nrow(compare_dfs(filtered_data)$div))) {
    record_overlap = compare_dfs(filtered_data)$div %>%
                          mutate(ref_label = as.factor(ref_label)) %>%
                          group_by(ref_label) %>% tally()
    record_overlap_perc = label_perc_overlap(record_overlap) %>%
                          replace(is.na(.), 0)
  } else {return(data.frame())}

  return(record_overlap_perc)
}

es1 = seq(-10,0,by=.01) #c(seq(0,.002,by=1e-5),seq(.01,1,by=.01))

es1_table = data.frame(neg_rate=numeric(length(es1)), pos_rate=numeric(length(es1)))
for (i in 1:length(es1)){
  if (i %% 50 == 0){
    print(es1[i])
  }
    results = filter_es1(es1[i])
    if (nrow(results)<1){
      next
    }
    es1_table[i,] = results$perc_overlap
}

es1_results = bind_cols(es1_table,list(es=es1))
# write.csv(es1_results,'data/divergence_es1_data.csv')
es1_results = read.csv('data/divergence_es1_data.csv')
es1_divergence = es1_results %>% mutate(rate_diff = abs(pos_rate-neg_rate)) %>% arrange(desc(rate_diff)) %>% top_n(1)

es1_roc =  es1_results%>%
          pivot_longer(c(pos_rate,neg_rate),
                          names_to = "label",
                          values_to = "rate"
                          ) %>%
          mutate(label = factor(label,levels=c("pos_rate","neg_rate")))

ggplot(es1_roc, aes(x=es,y=rate,color=label)) +
  geom_line() +
  geom_vline(xintercept = es1_divergence$es, linetype="dashed")+
  scale_color_discrete(name = "",
                      labels = c("Potential Positives","Potential Negatives")) +
  theme(legend.position="top") + xlab("log(Effect Size)") +
  ylab("Proportion") +
  coord_cartesian(xlim = c(-10,0), ylim=c(0,1)) +
  annotate("text", x = es1_divergence$es+1.3, y = .95, 
           label = paste0("log(effect size) = ", es1_divergence$es)) +
  annotate("text", x = es1_divergence$es+1.1, y = .9, 
           label = paste0("separation = ", round(es1_divergence$rate_diff,3)))
ggsave("plots/Report_div_es1.pdf") #,width = 15, height = 7, units = "cm")
```

## validation
```{r}
val_high_ES = val_risk_ES_data %>%
                    filter(effect_size_h > exp(es1_divergence$es))

val_high_ES_results = compare_vals(val_high_ES)$all %>%
                mutate(ref_grp = factor(ref_grp,
                                         levels=c("FP","TP","TN"))) %>%
                group_by(ref_grp,comparison) %>% tally()

val_ES_eval = val_ref_perc_overlap(val_high_ES_results) %>%
                  replace(is.na(.), 0)

ggplot(val_ES_eval %>%
                mutate(ref_grp = factor(ref_grp,
                                         levels=c("FP","TP","TN"))),
       aes(x=comparison,y=perc_overlap,fill=comparison,label=n)) +
  geom_col(show.legend = F, alpha=.8) +
  geom_text(position = position_dodge(width = 0.9),
            vjust = -.2) +
  scale_x_discrete(labels=c("cBio_TP" = "Chang True Positives", 
                            "Chang_TP" = "Chang Predictions",
                            "consensus" = "Consensus Positives",
                            "Brown_TP" = 'Brown "Driver"',
                            "Brown_FP" = 'Brown "Passenger"',
                            "Mutagene_TP" = 'Li "Non-netural"',
                            "Mutagene_FP" = 'Li "Netural"',
                            "UNK" = "No mentions")) +
  facet_grid(~ref_grp, 
             labeller = labeller(ref_grp = ref_labels),
             scale = "free", space="free"
             ) +
  theme(axis.text.x = element_text(angle=45,hjust=1),
        axis.title.x = element_blank(),
        legend.position="top"
        ) +
  coord_cartesian(ylim=c(0,.08)) +
  ylab("Proportion Identified")
ggsave("plots/Report_val_es_eval.pdf")
```
## threshold val rates
```{r}
es = seq(-12,0,by=.01)
es_table = data.frame(neg_rate=numeric(length(es)), pos_rate=numeric(length(es)))
for (i in 1:length(es)){
  if (i %% 50 == 0){
    print(es[i])
  }
  results = filter_rate(0,es[i])
  es_table[i,] = results$perc_overlap
}

es_results = bind_cols(es_table,list(es=es))
divergence = es_results %>% mutate(rate_diff = abs(pos_rate-neg_rate)) %>% arrange(desc(rate_diff)) %>% top_n(1)

es_roc =  es_results%>% 
          pivot_longer(c(pos_rate,neg_rate),
                          names_to = "label",
                          values_to = "rate"
                          ) %>%
          mutate(label = factor(label,levels=c("pos_rate","neg_rate")))

ggplot(es_roc, aes(x=es,y=rate,color=label)) +
  geom_line() +
  geom_vline(xintercept = divergence$es, linetype="dashed")+
  scale_color_discrete(name = "", 
                      labels = c("Potential Positives","Potential Negatives")) +
  theme(legend.position="top") +
  xlab("log(Effect Size)") +
  annotate("text", x = divergence$es+.5, y = .45, label = round(divergence$es,2))
```

## Risk
## Ref patterns: Risk
```{r}
# Risk Ratio:
# "the quotient between the risks, resp. probabilities for incidences in two different groups. The risk is computed by dividing the number of incidences by the total number in each group and building the ratio between the groups."

# Odds Ratio:
# "If for example 10 persons die in a group and 90 survive, than the odds in the groups would be 10/90, whereas the risk would be 10/(90+10). The odds ratio is the quotient between the odds of the two groups."

# Risk Difference:
# "the difference between two risks. Compared to the ratios, the risks are not divided but subtracted from each other. For the computation of Risk Differences, only the raw data is used, even when calculating variance and standard error. The measure has a disadvantage: It is highly influenced by changes in base rates."
pval_df = data_pvals %>% select(c(Codon_Id,obs.mu,E.mu,exact_bin))

risks_df = pval_df %>%
            mutate(risk_ratio = obs.mu/E.mu,
                   odds_ratio = (obs.mu/(1-obs.mu))/(E.mu/(1-E.mu)),
                   risk_diff = (obs.mu - E.mu)/total_patients
                   )

all_riskXq = compare_dfs(risks_df)$all %>%
              pivot_longer(c(risk_ratio,odds_ratio,risk_diff),
                           names_to = "measure",
                           values_to = "risk") %>%
              mutate(ref_grp = factor(ref_grp,
                                         levels=c("FP","TP","TN")))

measure_labels = c("Risk Ratio", "Risk Difference")
names(measure_labels) = c("risk_diff","risk_ratio")
ref_labels = c("False Positive","True Positive","True Negative")
names(ref_labels) = c("FP","TP","TN")

ggplot(all_riskXq %>% filter(measure == "risk_ratio"), 
       aes(x=comparison,y=log(risk),color=comparison)) +
  geom_boxplot(show.legend=F) +
  facet_grid(.~ref_grp,
             labeller = labeller(measure = measure_labels, ref_grp = ref_labels),
             scale="free",
             space = "free_x") +
  scale_x_discrete(labels=c("cBio_TP" = "Chang True Positives", 
                            "Chang_TP" = "Chang Predictions",
                            "consensus" = "Consensus Positives",
                            "Brown_TP" = 'Brown "Driver"',
                            "Brown_FP" = 'Brown "Passenger"',
                            "Mutagene_TP" = 'Li "Non-netural"',
                            "Mutagene_FP" = 'Li "Netural"',
                            "UNK" = "No mentions"
                            )) +
  theme(axis.text.x = element_text(angle=45,hjust=1),
        axis.title.x = element_blank(),
        ) +
  ylab("log(Risk Ratio)")
ggsave("plots/Report_ref_risk_ratio.pdf")
```
```{r}
sig_risk = all_discoveries %>% mutate(risk_ratio = obs.mu/E.mu) %>% filter(risk_ratio > exp(3)) %>% select(Codon_Id) %>% unique()

sig_risk_overlap = compare_dfs(sig_risk)$all %>%
                      group_by(comparison,ref_grp) %>%
                      tally()

sig_risk_perc = ref_grp_perc_overlap(sig_risk_overlap)

# ggplot(sig_risk_perc, aes(x=comparison,y=perc_overlap,fill=comparison)) +
#   geom_col(show.legend = F, alpha=.8) +
#   scale_x_discrete(labels=c("cBio_TP" = "Chang True Positives", 
#                             "Chang_TP" = "Chang Predictions",
#                             "consensus" = "Consensus Positives",
#                             "Brown_TP" = 'Brown "Driver"',
#                             "Brown_FP" = 'Brown "Passenger"',
#                             "Mutagene_TP" = 'Li "Non-netural"',
#                             "Mutagene_FP" = 'Li "Netural"',
#                             "UNK" = "No mentions")) +
#   facet_grid(~ref_grp, 
#              labeller = labeller(ref_grp = ref_labels),
#              scale = "free",space="free") +
#   theme(axis.text.x = element_text(angle=45,hjust=1),
#         axis.title.x = element_blank(),
#         legend.position="top"
#         ) +
#   ylab("Proportion Identified")

all_risk = ref_sig_val %>%
            mutate(risk_ratio = obs.mu/E.mu)

all_risk_labeled = compare_dfs(all_risk)$all %>%
                      group_by(comparison,ref_grp) %>%
                      tally()

ggplot(all_risk, aes(x=comparison,y=log(risk_ratio),color=comparison)) +
  geom_boxplot(show.legend = F) +
  scale_x_discrete(labels=c("cBio_TP" = "Chang True Positives", 
                            "Chang_TP" = "Chang Predictions",
                            "consensus" = "Consensus Positives",
                            "Brown_TP" = 'Brown "Driver"',
                            "Brown_FP" = 'Brown "Passenger"',
                            "Mutagene_TP" = 'Li "Non-netural"',
                            "Mutagene_FP" = 'Li "Netural"',
                            "UNK" = "No mentions")) +
  facet_grid(~ref_grp, 
             labeller = labeller(ref_grp = ref_labels),
             scale = "free",space="free") +
  theme(axis.text.x = element_text(angle=45,hjust=1),
        axis.title.x = element_blank()) +
  ylab("log(Risk Ratio)") +
  geom_hline(yintercept = 3, linetype="dashed")
```
## Discriminatory power: risk
```{r}
filter_rr1= function(crit_rr1) {
  filtered_data = risks_df %>% filter(risk_ratio < exp(crit_rr1))
  if (!is.null(nrow(compare_dfs(filtered_data)$div))) {
    record_overlap = compare_dfs(filtered_data)$div %>%
                          mutate(ref_label = as.factor(ref_label)) %>%
                          group_by(ref_label) %>% tally()
    record_overlap_perc = label_perc_overlap(record_overlap) %>%
                          replace(is.na(.), 0)
  } else {return(data.frame())}

  return(record_overlap_perc)
}

rr1 = seq(-1,12,by=.01)

rr1_table = data.frame(neg_rate=numeric(length(rr1)), pos_rate=numeric(length(rr1)))
for (i in 1:length(rr1)){
  if (i %% 50 == 0){
    print(rr1[i])
  }
    results = filter_rr1(rr1[i])
    if (nrow(results)<1){
      next
    }
    rr1_table[i,] = results$perc_overlap
}

rr1_results = bind_cols(rr1_table,list(rr=rr1))
# write.csv(alpha_results,'data/divergence_rr1_data.csv')
rr1_results = read.csv('data/divergence_rr1_data.csv')
rr1_divergence = rr1_results %>% mutate(rate_diff = abs(pos_rate-neg_rate)) %>% arrange(desc(rate_diff)) %>% top_n(1)

rr1_roc =  rr1_results%>%
          pivot_longer(c(pos_rate,neg_rate),
                          names_to = "label",
                          values_to = "rate"
                          ) %>%
          mutate(label = factor(label,levels=c("pos_rate","neg_rate")))

ggplot(rr1_roc, aes(x=rr,y=rate,color=label)) +
  geom_line() +
  geom_vline(xintercept = rr1_divergence$rr, linetype="dashed")+
  scale_color_discrete(name = "",
                      labels = c("Potential Positives","Potential Negatives")) +
  theme(legend.position="top") + xlab("log(Risk Ratio)") +
  ylab("Proportion") +
  coord_cartesian(xlim = c(-1,10), ylim=c(0,1)) +
  annotate("text", x = rr1_divergence$rr+1.5, y = .85, 
           label = paste0("log(Risk Ratio) = ", rr1_divergence$rr)) +
  annotate("text", x = rr1_divergence$rr+1.3, y = .8, 
           label = paste0("separation = ", round(rr1_divergence$rate_diff,3)))
  
# ggsave("plots/Report_div_rr1.pdf")
```

## Check risks with validation set
```{r}
val_ref_perc_overlap = function(result_df) return(full_join(result_df,val_ref_ct, by=c('ref_grp','comparison')) %>% mutate(perc_overlap = n/ref_records))

val_high_risk = val_risk_ES_data %>%
                    filter(risk_ratio > exp(rr1_divergence$rr))

val_high_risk_results = compare_vals(val_high_risk)$all %>%
                mutate(ref_grp = as.factor(ref_grp)) %>%
                group_by(ref_grp,comparison) %>% tally()

val_high_risk_eval = val_ref_perc_overlap(val_high_risk_results) %>%
                  replace(is.na(.), 0)

ggplot(val_high_risk_eval %>% mutate(ref_grp = factor(ref_grp,
                                         levels=c("FP","TP","TN"))),
       aes(x=comparison,y=perc_overlap,fill=comparison,label=n)) +
  geom_col(show.legend = F, alpha=.8) +
  geom_text(position = position_dodge(width = 0.9),
            vjust = -0.2) +
  scale_x_discrete(labels=c("cBio_TP" = "Chang True Positives", 
                            "Chang_TP" = "Chang Predictions",
                            "consensus" = "Consensus Positives",
                            "Brown_TP" = 'Brown "Driver"',
                            "Brown_FP" = 'Brown "Passenger"',
                            "Mutagene_TP" = 'Li "Non-netural"',
                            "Mutagene_FP" = 'Li "Netural"',
                            "UNK" = "No mentions")) +
  facet_grid(~ref_grp, 
             labeller = labeller(ref_grp = ref_labels),
             scale = "free", space="free"
             ) +
  theme(axis.text.x = element_text(angle=45,hjust=1),
        axis.title.x = element_blank(),
        legend.position="top"
        ) +
  ylab("Proportion Identified")

# ggsave("plots/Report_val_risk_eval.pdf")
```
## High Risk x Effect Size
```{r}
risk_ES_data = pwr_df %>% mutate(risk_ratio = obs.mu/E.mu) 

riskXes_df = risk_ES_data %>% filter(risk_ratio > exp(rr1_divergence$rr), effect_size_h > exp(es1_divergence$es)) #inner_join(sig_risk,high_ES,by='Codon_Id') %>% select(Codon_Id) %>% unique()

high_risk_df = risk_ES_data %>% filter(risk_ratio > exp(rr1_divergence$rr))
high_risk_labeled = compare_dfs(high_risk_df)$all %>%
                      group_by(comparison,ref_grp) %>%
                      tally()
sig_risk_perc = ref_grp_perc_overlap(high_risk_labeled) %>%
                mutate(disc_method = "Risk")
high_ES_df = risk_ES_data %>% filter(effect_size_h > exp(es1_divergence$es))
high_ES_labeled = compare_dfs(high_ES_df)$all %>%
                      group_by(comparison,ref_grp) %>%
                      tally()
sig_ES_perc = ref_grp_perc_overlap(high_ES_labeled) %>%
                mutate(disc_method = "ES")

riskXes_labeled = compare_dfs(riskXes_df)$all %>%
                      group_by(comparison,ref_grp) %>%
                      tally()

# riskXes_perc = ref_grp_perc_overlap(riskXes_labeled) %>%
#                 mutate(disc_method = "RxES")


BFq_thres = all_discoveries %>% filter(BF_qval < exp(-1))
BYq_thres = all_discoveries %>% filter(BY_qval < exp(-7.3))

BF_results = compare_dfs(BFq_thres)$all %>%
                mutate(ref_grp = as.factor(ref_grp)) %>%
                group_by(disc_method,ref_grp,comparison) %>% tally()
BY_results = compare_dfs(BYq_thres)$all %>%
                mutate(ref_grp = as.factor(ref_grp)) %>%
                group_by(disc_method,ref_grp,comparison) %>% tally()

BF_perc = ref_grp_perc_overlap(BF_results) %>% mutate(disc_method="BF_q")
BY_perc = ref_grp_perc_overlap(BY_results) %>% mutate(disc_method="BY_q")

all_metrics = bind_rows(BF_perc,BY_perc,
                        sig_risk_perc, sig_ES_perc
                                 ) %>%
                        mutate(disc_method = factor(disc_method,
                                               levels=c("ES","Risk","BF_q","BY_q")))


ggplot(all_metrics, aes(x=comparison,y=perc_overlap)) +
  geom_bar(aes(fill=disc_method),
          position="dodge", stat="identity", alpha = .8) +
  scale_x_discrete(labels=c("cBio_TP" = "Chang True Positives", 
                            "Chang_TP" = "Chang Predictions",
                            "consensus" = "Consensus Positives",
                            "Brown_TP" = 'Brown "Driver"',
                            "Brown_FP" = 'Brown "Passenger"',
                            "Mutagene_TP" = 'Li "Non-netural"',
                            "Mutagene_FP" = 'Li "Netural"',
                            "UNK" = "No mentions")) +
  facet_grid(~ref_grp, 
             labeller = labeller(ref_grp = ref_labels),
             scale = "free",space="free") +
  theme(axis.text.x = element_text(angle=45,hjust=1),
        axis.title.x = element_blank(),
        legend.position="top"
        ) +
  ylab("Proportion Identified") +
  scale_fill_discrete(name = "", 
                      labels = c("Effect Size", "Risk ratio", 
                                 "Bonferroni q-value",
                                 "B-Y q-value"))
ggsave('plots/Report_CS_results.pdf')
```
## Check high Risk x Effect Size on validation
```{r}
risks_ES_data = pval_df %>%
                  mutate(risk_ratio = obs.mu/E.mu,
                         
                         )

val_rXES_df = val_risk_ES_data %>%
                    filter(risk_ratio > exp(3), effect_size_h > exp(-4.5))

val_rXES_results = compare_vals(val_rXES_df)$all %>%
                        mutate(ref_grp = as.factor(ref_grp)) %>%
                        group_by(ref_grp,comparison) %>% tally()

val_rXES_eval = val_ref_perc_overlap(val_rXES_results) %>%
                  replace(is.na(.), 0)



ggplot(val_risk_eval, aes(x=comparison,y=perc_overlap,fill=comparison,label=n)) +
  geom_col(show.legend = F, alpha=.8) +
  geom_text(position = position_dodge(width = 0.9),
            vjust = 3) +
  scale_x_discrete(labels=c("cBio_TP" = "Chang True Positives", 
                            "Chang_TP" = "Chang Predictions",
                            "consensus" = "Consensus Positives",
                            "Brown_TP" = 'Brown "Driver"',
                            "Brown_FP" = 'Brown "Passenger"',
                            "Mutagene_TP" = 'Li "Non-netural"',
                            "Mutagene_FP" = 'Li "Netural"',
                            "UNK" = "No mentions")) +
  facet_grid(~ref_grp, 
             labeller = labeller(ref_grp = ref_labels),
             scale = "free", space="free"
             ) +
  theme(axis.text.x = element_text(angle=45,hjust=1),
        axis.title.x = element_blank(),
        legend.position="top"
        ) +
  ylab("Proportion Identified")
```
